---
title: "TB Vaccination"
output: 
  - pdf_document
  - html_notebook
---

PDF Version available [here](http://rwhite.no/tb_vaccination/tb_vaccination.pdf).

## Data creation

```{r, message=FALSE, warning=FALSE}
library(data.table)
library(pomp)
library(ggplot2)
library(rstan)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

#everyone enters on jan 1
#results are for dec 31
newPeople <- data.table(id=1:100,year=2000,age=1,timeNoVax=0,timeWithVax=0,vaccinated=0,ltbi=0,atbi=0)

pomp::bake("data/peopleNoVax.RDS",{
  set.seed(4)
  peopleNoVax <- vector("list",length=17)
  peopleNoVax[[1]] <- newPeople[1,][-1,]
  for(i in 1:17){
    # NO VACCINATIONS
    if(i!=1) peopleNoVax[[i]] <- copy(peopleNoVax[[i-1]])
    peopleNoVax[[i]][,age:=age+1]
    peopleNoVax[[i]] <- rbind(peopleNoVax[[i]],newPeople)
    peopleNoVax[[i]][,year:=2000+i]
    
    N <- nrow(peopleNoVax[[i]])
    peopleNoVax[[i]][sample(1:N,size=round(N*0.050)),ltbi:=1]
    peopleNoVax[[i]][,timeNoVax:=timeNoVax+1]
    
    Nltbi <- sum(peopleNoVax[[i]]$ltbi)
    peopleNoVax[[i]][sample(which(peopleNoVax[[i]]$ltbi==1),size=round(Nltbi*0.05)),atbi:=1]
  }
  peopleNoVax
}) -> peopleNoVax

pomp::bake("data/peopleWithVax.RDS",{
  set.seed(4)
  peopleWithVax <- vector("list",length=17)
  peopleWithVax[[1]] <- newPeople[1,][-1,]
  for(i in 1:17){
    # WITH VACCINATIONS, BUT STOPPING THEM AFTERWARDS
    if(i!=1) peopleWithVax[[i]] <- copy(peopleWithVax[[i-1]])
    peopleWithVax[[i]][,age:=age+1]
    peopleWithVax[[i]] <- rbind(peopleWithVax[[i]],newPeople)
    peopleWithVax[[i]][,year:=2000+i]
    N <- nrow(peopleWithVax[[i]])
    if(i>=10){
      peopleWithVax[[i]][sample(1:N,size=round(N*0.050)),ltbi:=1]
      peopleWithVax[[i]][,timeNoVax:=timeNoVax+1]
    } else {
      peopleWithVax[[i]][sample(1:N,size=round(N*0.050)),ltbi:=1]
      peopleWithVax[[i]][,timeWithVax:=timeWithVax+1]
    }
    
    Nltbi <- sum(peopleWithVax[[i]]$ltbi)
    peopleWithVax[[i]][sample(which(peopleWithVax[[i]]$ltbi==1),size=round(Nltbi*0.05)),atbi:=1]
  }
  peopleWithVax
}) -> peopleWithVax
```

## Detecting LTBI without vaccination

Lets try an easy model, detecting LTBI in unvaccinated people.

We have a Poisson binomial distribution, where the probability of person $i$ not having LTBI is:

$$Pr(Y_i=0 | p, T_i) = 1 - (1-p)^{T_i}$$

And the probability of person $i$ having LTBI is:

$$Pr(Y_i=1 | p, T_i) = 1 - Pr(Y_i=0 | p, T_i)$$

```{r}
stanData=peopleNoVax[[17]]
data = list(N=nrow(stanData),
            y=stanData$ltbi,
            timeNoVax=stanData$timeNoVax)

stan_code = "
data {
  int<lower=0> N;
  vector[N] timeNoVax;
  int y[N];
}
parameters {
  real<lower=0,upper=0.5> thetaNoVax;
}
model {
  thetaNoVax ~ beta(0.05, 1);
  
  for (n in 1:N) 
    y[n] ~ bernoulli(1-((1-thetaNoVax)^timeNoVax[n]));
}
"
pomp::bake("results/noVaxLTBI.RDS",{
  stan(model_code=stan_code,
              model_name="noVaxLTBI",
              data=data,
              iter=10000, chains=4, init=0, seed=4)
}) -> fit
summary(fit)$summary
```

## Detecting LTBI with vaccination

Lets try a harder model, detecting LTBI when vaccination originally exists, and is then phased out.

We have a Poisson binomial distribution, where the probability of person not $i$ having LTBI is:

$$Pr(Y_i=0 | p_w, p_n, TW_i, TN_i) = 1-(1-p_w)^{TW_i} \times (1-p_n)^{TN_i}$$

And the probability of person $i$ not having LTBI is:

$$Pr(Y_i=1 | p_w, p_n, TW_i, TN_i) = 1 - Pr(Y_i=0 | p_w, p_n, TW_i, TN_i)$$

```{r}
stanData=peopleNoVax[[17]]
data = list(N=nrow(stanData),
            y=stanData$ltbi,
            timeNoVax=stanData$timeNoVax,
            timeWithVax=stanData$timeWithVax
            )

stan_code = "
data {
  int<lower=0> N;
  vector[N] timeWithVax;
  vector[N] timeNoVax;
  int y[N];
}
parameters {
  real<lower=0,upper=0.5> thetaWithVax;
  real<lower=0,upper=0.5> thetaNoVax;
}
model {
  thetaWithVax ~ beta(0.05, 1);
  thetaNoVax ~ beta(0.05, 1);
  
  for (n in 1:N) 
    y[n] ~ bernoulli(1-((1-thetaWithVax)^timeWithVax[n])*((1-thetaNoVax)^timeNoVax[n]));
}
"
pomp::bake("results/withVaxLTBI.RDS",{
  stan(model_code=stan_code,
              model_name="withVaxLTBI",
              data=data,
              iter=10000, chains=4, init=0, seed=4)
}) -> fit
summary(fit)$summary
```


